#!/usr/bin/env bash

bootstrap_build() {
  sudo apt-get install python-pycurl ansible -qq

  local ansible_path="jalcine/wintermute/ansible/site.yml"

  if [ "$USER" == "vagrant" ]; then
    local ansible_path="/vagrant/ansible/site.yml"
  else
    if [ "$TRAVIS" == true ]; then
      sudo apt-get install aptitude -qq
      local ansible_path="$TRAVIS_BUILD_DIR/ansible/site.yml"
    fi
  fi

  echo "export LD_LIBRARY_PATH=/usr/local/lib:/usr/lib" \
    | sudo tee /etc/profile.d/local_lib.sh

  hostname | sudo tee /etc/ansible/hosts > /dev/null
  echo -en "\n[bootstrap] Building for '${CC:gcc}' toolchain...\n";
  ansible-playbook -c local --extra-vars="compiler_family=${CC:gcc}" \
    "${ansible_path}"
}

dump_log() {
  if [ "$TRAVIS" == true ]; then
    cat "$(find "$TRAVIS_BUILD_DIR" -type f -name "*Last*.log")";
  else
    cat "$(find ~vagrant/build -type f -name "*Last*.log")";
  fi
}

run_build() {
  make -j2 all;
  make -e test;
  local _exit=$?;
  echo -en "[test] Testing exited with code ${_exit}.\n";
  if [ $_exit -gt 0 ]; then
    dump_log;
    exit $_exit;
  else
    exit 0;
  fi
}

generate_build() {
  local _compiler=$(which g++);

  if [ "${CC}" == "clang" ]; then
    _compiler=$(which clang-3.5);
  fi

  CC=gcc CXX=${_compiler} cmake \
    -DCI_BUILD=ON "$1" || exit 32
}


# Force CTest to run tests in parallel.
export CTEST_PARALLEL_LEVEL=2

# Use the provided `gcov` path.
export GCOV=$(which gcov)

case "$1" in
  "--before" )
    bootstrap_build || exit 16
    ;;
  "--generate" )
    generate_build .
    ;;
  "--generate-vagrant" )
    cd ~vagrant;
    rm build -rf;
    mkdir build 2> /dev/null; cd build
    generate_build /vagrant
    ;;
  "--run" )
    run_build
    ;;
  "--run-vagrant" )
    cd ~vagrant/build;
    run_build
    ;;
  "--dump-log" )
    dump_log
    ;;
  "--vagrant" )
    /vagrant/test/bootstrap --generate-vagrant
    /vagrant/test/bootstrap --run-vagrant
    ;;
  "--dump-log" )
    if [ "$TRAVIS" == true ]; then
      cat "$(find "$TRAVIS_BUILD_DIR" -type f -name "*LastBuild*.log")";
    else
      cat "$(find ~vagrant/build -type f -name "*LastBuild*.log")";
    fi
    ;;
  "--post" )
    coveralls --gcov "${GCOV}" --gcov-options "\-lcfd" -r . --include src --exclude test -t "${COVERALLS_TOKEN}"
    ;;
esac
